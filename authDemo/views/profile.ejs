<!doctype html>
<html>
<head>
  <title>Node Authentication</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
  <style>
      body        { word-wrap:break-word; }
  </style>
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="/reload/reload.js"></script>
  
  <script>
    // this functions builds the testrun table
    function buildTableRows(user)
    {
      let markup = '';
      markup += "<tbody>";
      user.testRuns.reverse().forEach(function(testrun, i){
        // because array is reverserd, indexes should be in reverse order aswell
        let index = user.testRuns.length - 1 - i; 
        markup += `
        <tr> 
          <td>${testrun._id}</td>         
          <td>${testrun.date}</td>
          <td><a href="/download/${index}">
            ${testrun.firmware.filename}.${testrun.firmware.filetype}
          </a></td>
          <td>${testrun.status}</td>
        </tr> 
        `;
      });
      markup += "</tbody>";
      return markup;
    }

    var update_table = null; // variable as placeholder for jquery function
    $(function() { 
      function my_fun(user){ // jquery function to update table
        let result = buildTableRows(user);
        console.log(result)
        $("table tbody").replaceWith(result);
      }  
      update_table = my_fun; // store function in variable to access it from js
    }) 

    // assume that API service is published on same server that is the server of this HTML file
    var source = new EventSource("../updates");
    source.onmessage = function(event) {
      var data = JSON.parse(event.data); // parse data received
      var inputCell= document.getElementById("console");
      if(data["_id"]) // if data is passed, update table
      {
        console.log(data['index']);
        update_table(data, data["index"]);
      }
      else // else just output what we received
      {
        inputCell.innerHTML = inputCell.innerHTML + data;
      }
    };
  </script>
</head>
<body>

<div class="container">
  <div class="page-header text-center">
    <h1><span class="fa fa-anchor"></span> Profile Page</h1>
    <a href="/logout" class="btn btn-default btn-sm">Logout</a>
  </div>
  <div class="row">
    <!-- USER INFORMATION -->
    <div class="col-md-6">
      <div class="well">
        <h3><span class="fa fa-user"></span> Local</h3>
          <p>
            <strong>email</strong>: <%= email %><br>
          </p>
      </div>
    </div>

    <!-- UPLOAD FORM -->
    <div class="col-md-6">
      <div class="well">
        <!-- LOGIN FORM -->
        <form action="/fileupload" method="post" enctype="multipart/form-data" target="formtarget">
          <div class="form-group">
            <label>Test run argument</label>
            <input type="text" class="form-control" name="argument">
          </div>
          <div class="form-group">
            <label>Binary</label>
            <input type="file" class="form-control" name="file">
          </div>
          <button type="submit" class="btn btn-warning btn-lg">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <iframe name="formtarget"style="display:none"></iframe>

  <div class="row">
    <!-- TESTRUNS -->
    <div class="col-md-12">
      <div class="well">
        <h3><span class="fa fa-wrench"></span> Testruns</h3>
        <div class="table-wrapper-scroll-y">
          <table class="table table-striped" id="testruntable">
            <thead>
              <tr>
                <th>Id</th>
                <th>Date</th>
                <th>Firmware</th>
                <th>Status</th>               
              </tr>    
            </thead>  
              <script>
                let user = <%- user %>;
                document.write(buildTableRows(user));
              </script>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- TERMINAL -->
    <div class="col-lg-12">
      <div class="terminal-wrapper-scroll-y">
        <div id="console"class="well">
          <h3>Terminal</h3>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
